!pip install -q flask flask-cors requests beautifulsoup4 pyngrok lxml newspaper3k lxml_html_clean transformers torch sentencepiece
!pip install -U newspaper3k

print("ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ! (ì‹œê°„ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”)")

# -----------------------------
# ì„œë²„ ì½”ë“œ
# -----------------------------
from flask import Flask, jsonify, request, render_template_string
from flask_cors import CORS
import os, requests, json, time, re, random, threading
from datetime import datetime
from bs4 import BeautifulSoup
from pyngrok import ngrok
import nest_asyncio
from newspaper import Article
from transformers import pipeline, AutoTokenizer, AutoModelForSeq2SeqLM

# Colab ë¹„ë™ê¸° ê´€ë ¨
nest_asyncio.apply()

app = Flask(__name__)
CORS(app, resources={r"/api/*": {"origins": "*"}})

# -----------------------------
# í™˜ê²½ë³€ìˆ˜
# -----------------------------
os.environ.setdefault('NAVER_CLIENT_ID', 'fe9DLGhYbEVLy4sdQnVk')
os.environ.setdefault('NAVER_CLIENT_SECRET', '2f0NEntTNN')
os.environ.setdefault('NEWSAPI_KEY', 'a80b5826f01349c5824f4298d8f61eef')
NGROK_AUTHTOKEN = "30KyKWx0zSS7ZJpm5TnJOKdI6fC_7y1Lta8QCMEyH6ZLjjrxj"

CATEGORIES = {
    'ì •ì¹˜': 'politics',
    'ê²½ì œ': 'business',
    'ì‚¬íšŒ': 'society',
    'ìƒí™œë¬¸í™”': 'life',
    'ì—°ì˜ˆ': 'entertainment',
    'ìŠ¤í¬ì¸ ': 'sports',
    'ê±´ê°•': 'health',
    'ì˜¤ëŠ˜ì˜ì¶”ì²œ': 'today'
}

# -----------------------------
# ìš”ì•½ ëª¨ë¸ ì´ˆê¸°í™” (ê²½ëŸ‰í™” T5 ëª¨ë¸ë¡œ ë³€ê²½)
# -----------------------------
def init_summarizer():
    print("ğŸ” ê²½ëŸ‰ í•œêµ­ì–´ ìš”ì•½ ëª¨ë¸ì„ ë¡œë“œí•©ë‹ˆë‹¤... (ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤!)")
    
    # ì¶”ì²œ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ (ê°€ë²¼ìš´ ìˆœì„œ)
    candidates = [
        "eenzeenee/t5-small-korean-summarization",
        "gogamza/kobart-summarization" # í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ëª¨ë¸
    ]

    for model_name in candidates:
        try:
            tokenizer = AutoTokenizer.from_pretrained(model_name)
            model = AutoModelForSeq2SeqLM.from_pretrained(model_name)
            
            # T5 ëª¨ë¸ì€ íŠ¹ì • í”„ë¡¬í”„íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            # pipelineì„ ì‚¬ìš©í•˜ë©´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ëŠ” ê²½ìš°ê°€ ë§ì§€ë§Œ,
            # í˜¹ì‹œ ë¬¸ì œê°€ ìƒê¸°ë©´ ì§ì ‘ inputì„ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
            summarizer = pipeline("summarization", model=model, tokenizer=tokenizer, framework="pt")
            
            print(f"âœ… ê²½ëŸ‰ ìš”ì•½ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ: {model_name}")
            return summarizer
        except Exception as e:
            print(f"âš ï¸ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ ({model_name}): {e}")
            continue

    print("âš ï¸ ëª¨ë“  ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. ë£° ê¸°ë°˜ ìš”ì•½(fallback)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
    return None

summarizer = init_summarizer()

# make_summary í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ë‘ì…”ë„ ë©ë‹ˆë‹¤.
# max_length, min_length íŒŒë¼ë¯¸í„°ë¡œ ë¯¸ë¦¬ë³´ê¸°/ìƒì„¸ë³´ê¸° ìš”ì•½ ì¡°ì ˆ ê°€ëŠ¥

# -----------------------------
# HTML íƒœê·¸ ì œê±° ë° ê¸°ì‚¬ ë³¸ë¬¸ ì¶”ì¶œ
# -----------------------------
def clean_text(html_text):
    if not html_text:
        return ""
    text = re.sub(r'<[^>]+>', '', html_text)
    text = re.sub(r'\s+', ' ', text).strip()
    return text

def get_article_text(url):
    try:
        article = Article(url, language='ko')
        article.download()
        article.parse()
        return article.text
    except Exception as e:
        print(f"âš ï¸ ê¸°ì‚¬ ë³¸ë¬¸ ì¶”ì¶œ ì‹¤íŒ¨: {e}")
        return None

# -----------------------------
# ëŒ€í‘œ ì´ë¯¸ì§€ & ì¡°íšŒìˆ˜ ì¶”ì¶œ
# -----------------------------
def extract_image_and_views(url, timeout=6):
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
    try:
        resp = requests.get(url, headers=headers, timeout=timeout)
        if resp.status_code != 200:
            return None, None
        soup = BeautifulSoup(resp.content, 'html.parser')
        img_selectors = [
            ('meta[property="og:image"]', 'content'),
            ('meta[name="twitter:image"]', 'content'),
            ('meta[itemprop="image"]', 'content'),
            ('img[class*="thumb"]', 'src'),
            ('img[class*="photo"]', 'src'),
            ('article img', 'src'),
            ('img', 'src')
        ]
        image = None
        for sel, attr in img_selectors:
            tag = soup.select_one(sel)
            if tag:
                image = tag.get(attr) if getattr(tag, 'get', None) else None
                if image and image.startswith('//'):
                    image = 'https:' + image
                if image:
                    break
        text = soup.get_text(separator=' ')
        view_patterns = [
            r'ì¡°íšŒìˆ˜[^\d]*([\d,]+)',
            r'ì¡°íšŒ[^\d]*([\d,]+)',
            r'Views[^\d]*([\d,]+)',
            r'views[^\d]*([\d,]+)',
            r'view[^\d]*([\d,]+)',
            r'ì½ìŒ[^\d]*([\d,]+)',
            r'PV[^\d]*([\d,]+)'
        ]
        views = None
        for p in view_patterns:
            m = re.search(p, text, re.IGNORECASE)
            if m:
                v = m.group(1)
                v = int(re.sub(r'[^0-9]', '', v))
                views = v
                break
        if not image:
            try:
                art = Article(url)
                art.download()
                art.parse()
                if art.top_image:
                    image = art.top_image
            except Exception:
                pass
        return image, views
    except Exception:
        return None, None

# -----------------------------
# ìš”ì•½ í•¨ìˆ˜ ìˆ˜ì •
# -----------------------------
def make_summary(text, mode='preview'):
    text = (text or "").strip()
    if not text:
        return ""
    
    if summarizer:
        try:
            # KoBARTëŠ” 512 í† í° ì œí•œì´ ìˆìœ¼ë¯€ë¡œ, ì…ë ¥ í…ìŠ¤íŠ¸ë¥¼ ì ì ˆíˆ ì˜ë¼ì¤ë‹ˆë‹¤.
            text_to_summarize = text[:1000] 
            
            if mode == 'preview':
                # ë¯¸ë¦¬ë³´ê¸°: 1~2ì¤„ ìš”ì•½ (max_lengthë¥¼ ì§§ê²Œ ì„¤ì •)
                out = summarizer(text_to_summarize, max_length=150, min_length=50, do_sample=True, top_p=0.92)
            else:
                # ìƒì„¸ ìš”ì•½: 3~6ì¤„ ìš”ì•½ (max_lengthë¥¼ ê¸¸ê²Œ ì„¤ì •)
                out = summarizer(text_to_summarize, max_length=250, min_length=100, do_sample=True, top_p=0.92)
            
            summary = out[0]['summary_text'].strip()
            
            # ìš”ì•½ì´ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚˜ë„ë¡ ë³´ì •
            if not summary.endswith(('.', '!', '?', 'â€¦')):
                summary += '.'
            
            return summary
        except Exception as e:
            print(f"âš ï¸ ìš”ì•½ ëª¨ë¸ ì˜¤ë¥˜: {e}")
            pass

    # ëª¨ë¸ ìš”ì•½ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ (Fallback)
    sentences = re.split(r'(?<=[.!?ã€‚ï¼ï¼Ÿ])\s+', text)
    if mode == 'preview':
        # 2ë¬¸ì¥ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° ìš”ì•½
        return " ".join(sentences[:2])[:300] + ("..." if len(" ".join(sentences[:2])) > 300 else "")
    else:
        # 6ë¬¸ì¥ìœ¼ë¡œ ìƒì„¸ ìš”ì•½
        return " ".join(sentences[:6])[:2000] + ("..." if len(" ".join(sentences[:6])) > 2000 else "")

# -----------------------------
# NewsService í´ë˜ìŠ¤
# -----------------------------
class NewsService:
    def __init__(self):
        self.naver_client_id = os.environ.get('NAVER_CLIENT_ID')
        self.naver_client_secret = os.environ.get('NAVER_CLIENT_SECRET')
        self.newsapi_key = os.environ.get('NEWSAPI_KEY')
        self.query_map = {
            'ì •ì¹˜': 'ì •ì¹˜', 'ê²½ì œ': 'ê²½ì œ', 'ì‚¬íšŒ': 'ì‚¬íšŒ',
            'ìƒí™œë¬¸í™”': 'ìƒí™œ ë¬¸í™”', 'ì—°ì˜ˆ': 'ì—°ì˜ˆ',
            'ìŠ¤í¬ì¸ ': 'ìŠ¤í¬ì¸ ', 'ê±´ê°•': 'ê±´ê°•',
            'ì˜¤ëŠ˜ì˜ì¶”ì²œ': 'ë‰´ìŠ¤'
        }
    def get_naver_news(self, category, count=5):
        url = "https://openapi.naver.com/v1/search/news.json"
        headers = {
            'X-Naver-Client-Id': self.naver_client_id,
            'X-Naver-Client-Secret': self.naver_client_secret
        }
        params = {'query': self.query_map.get(category, 'ë‰´ìŠ¤'), 'display': count, 'start': 1, 'sort': 'date'}
        try:
            r = requests.get(url, headers=headers, params=params, timeout=6)
            r.raise_for_status()
            return r.json().get('items', [])
        except Exception as e:
            print("ë„¤ì´ë²„ API ì˜¤ë¥˜:", e)
            return []
    def get_newsapi_news(self, category, count=5):
        url = "https://newsapi.org/v2/top-headlines"
        params = {'apiKey': self.newsapi_key, 'pageSize': count, 'page': 1,
                    'category': map_category_newsapi(category), 'language': 'ko'}
        try:
            r = requests.get(url, params=params, timeout=6)
            r.raise_for_status()
            data = r.json()
            return data.get('articles', [])
        except Exception as e:
            print("NewsAPI ì˜¤ë¥˜:", e)
            return []

news_service = NewsService()

def map_category_newsapi(category):
    mapping = {'ì •ì¹˜': None, 'ê²½ì œ': 'business', 'ì‚¬íšŒ': None, 'ìƒí™œë¬¸í™”': None,
               'ì—°ì˜ˆ': 'entertainment', 'ìŠ¤í¬ì¸ ': 'sports', 'ê±´ê°•': 'health'}
    return mapping.get(category, None)

def normalize_and_enrich(items, source='naver', category='ì¼ë°˜'):
    normalized = []
    for it in items:
        try:
            if source == 'naver':
                title = clean_text(it.get('title'))
                description = clean_text(it.get('description'))
                link = it.get('link')
                
                # ë„¤ì´ë²„ ë‚ ì§œ í˜•ì‹ ë³€í™˜
                pub_date_raw = it.get('pubDate')
                try:
                    # 'Sun, 07 Sep 2025 16:06:00 +0900' í˜•ì‹ íŒŒì‹±
                    dt_obj = datetime.strptime(pub_date_raw, '%a, %d %b %Y %H:%M:%S %z')
                    # '2025/09/07 +0900 16:06:00' í˜•ì‹ìœ¼ë¡œ ì¬í¬ë§·
                    pub_date = dt_obj.strftime('%Y/%m/%d %z %H:%M:%S')
                except (ValueError, TypeError):
                    pub_date = pub_date_raw # ì‹¤íŒ¨ ì‹œ ì›ë˜ ê°’ ìœ ì§€

                # ë„¤ì´ë²„ëŠ” descriptionì´ ì§§ì•„, ê¸°ì‚¬ ë³¸ë¬¸ì„ ì§ì ‘ í¬ë¡¤ë§
                full_text = get_article_text(link)
                text_to_summarize = full_text if full_text and len(full_text) > 100 else (title + ". " + description)
            else:
                title = it.get('title') or ''
                description = it.get('description') or (it.get('content') or '')
                link = it.get('url')
                
                # NewsAPI ë‚ ì§œ í˜•ì‹ ë³€í™˜ (ISO 8601)
                pub_date_raw = it.get('publishedAt')
                try:
                    dt_obj = datetime.fromisoformat(pub_date_raw.replace('Z', '+00:00'))
                    pub_date = dt_obj.strftime('%Y/%m/%d %z %H:%M:%S')
                except (ValueError, TypeError):
                    pub_date = pub_date_raw
                
                text_to_summarize = (title + ". " + description)
            
            preview = make_summary(text_to_summarize, mode='preview')
            detailed = make_summary(text_to_summarize, mode='detailed')
            image_url, views = extract_image_and_views(link)
            
            # ì¡°íšŒìˆ˜(views)ê°€ ì—†ì„ ê²½ìš° 'None'ìœ¼ë¡œ ì„¤ì •
            views_display = str(views) if views is not None else "None"

            news_item = {
                "title": title, "description": description, "link": link, "pub_date": pub_date,
                "image_url": image_url, "view_count": views_display,
                "preview_summary": preview, "detailed_summary": detailed,
                "source": source, "category": category, "is_headline": False
            }
            normalized.append(news_item)
        except Exception as e:
            continue
    return normalized

# -----------------------------
# API ì—”ë“œí¬ì¸íŠ¸
# -----------------------------
@app.after_request
def after_request(response):
    response.headers.add('Access-Control-Allow-Origin', '*')
    response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization')
    response.headers.add('Access-Control-Allow-Methods', 'GET,POST,OPTIONS')
    return response

@app.route('/')
def home():
    return jsonify({
        "message": "ğŸ—ï¸ ë‰´ìŠ¤ ì¶”ì²œ AI ì„œë²„ (ì™„ì„±ë³¸) ì‹¤í–‰ì¤‘!",
        "endpoints": {
            "/api/news/<category>": "ì¹´í…Œê³ ë¦¬ë³„ ë‰´ìŠ¤ ì¡°íšŒ",
            "/api/news": "ì „ì²´ ì¹´í…Œê³ ë¦¬ ë‰´ìŠ¤ ì¡°íšŒ",
            "/api/categories": "ì§€ì› ì¹´í…Œê³ ë¦¬ ëª©ë¡",
            "/test": "ì›¹ í…ŒìŠ¤íŠ¸ í˜ì´ì§€"
        },
        "categories": list(CATEGORIES.keys()),
        "status": "running"
    })

# -----------------------------
# ì›¹ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ìˆ˜ì • (ì˜¤ëŠ˜ì˜ì¶”ì²œ ë²„íŠ¼)
# -----------------------------
TEST_PAGE_HTML = """
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ë‰´ìŠ¤ AI ì„œë²„ í…ŒìŠ¤íŠ¸</title>
<style>
body{font-family:Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#667eea,#764ba2);margin:0;padding:20px}
.container{max-width:1100px;margin:0 auto;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.15)}
.header{background:#2c3e50;color:#fff;padding:18px;text-align:center}
.controls{padding:16px;background:#f8f9fa;border-bottom:1px solid #e9ecef}
.input-group{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,input{padding:8px;border-radius:6px;border:1px solid #ddd}
.btn{padding:8px 12px;border-radius:6px;background:#007bff;color:#fff;border:none;cursor:pointer}
.results{padding:16px}
.news-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.news-card{border:1px solid #eee;border-radius:8px;overflow:hidden;background:#fff}
.news-card img{width:100%;height:180px;object-fit:cover}
.content{padding:12px}
.badge{display:inline-block;padding:4px 8px;border-radius:12px;background:#ff4757;color:#fff;font-size:12px;margin-right:6px}
.meta{font-size:12px;color:#666;margin-top:8px}
.json-viewer{background:#f7f7f7;padding:12px;border-radius:6px;white-space:pre-wrap;max-height:400px;overflow:auto}
.today-btn{margin-right:6px;margin-top:4px}
</style>
</head>
<body>
<div class="container">
    <div class="header"><h2>ë‰´ìŠ¤ AI ì„œë²„ í…ŒìŠ¤íŠ¸</h2><div>ì„œë²„ ì‹¤í–‰ì¤‘</div></div>
    <div class="controls">
        <div style="margin-bottom:8px;">
            <label>ì¹´í…Œê³ ë¦¬:</label>
            <select id="category">
                <option value="">ì „ì²´</option>
                <option value="ì •ì¹˜">ì •ì¹˜</option>
                <option value="ê²½ì œ">ê²½ì œ</option>
                <option value="ì‚¬íšŒ">ì‚¬íšŒ</option>
                <option value="ìƒí™œë¬¸í™”">ìƒí™œë¬¸í™”</option>
                <option value="ì—°ì˜ˆ">ì—°ì˜ˆ</option>
                <option value="ìŠ¤í¬ì¸ ">ìŠ¤í¬ì¸ </option>
                <option value="ê±´ê°•">ê±´ê°•</option>
                <option value="ì˜¤ëŠ˜ì˜ì¶”ì²œ">ì˜¤ëŠ˜ì˜ì¶”ì²œ</option>
            </select>
            <button class="btn" onclick="fetchNews()">ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°</button>
            <button class="btn" onclick="showJson()">JSON ë³´ê¸°</button>
        </div>
        <div id="todayBtns" style="margin-bottom:8px;">
            <label>ì˜¤ëŠ˜ì˜ì¶”ì²œ ì„ íƒ:</label>
            <button class="btn today-btn" data-cat="ì •ì¹˜">ì •ì¹˜</button>
            <button class="btn today-btn" data-cat="ê²½ì œ">ê²½ì œ</button>
            <button class="btn today-btn" data-cat="ì‚¬íšŒ">ì‚¬íšŒ</button>
            <button class="btn today-btn" data-cat="ìƒí™œë¬¸í™”">ìƒí™œë¬¸í™”</button>
            <button class="btn today-btn" data-cat="ì—°ì˜ˆ">ì—°ì˜ˆ</button>
            <button class="btn today-btn" data-cat="ìŠ¤í¬ì¸ ">ìŠ¤í¬ì¸ </button>
            <button class="btn today-btn" data-cat="ê±´ê°•">ê±´ê°•</button>
        </div>
    </div>
    <div class="results">
        <div id="status"></div>
        <div id="newsContainer"></div>
    </div>
</div>

<script>
let currentData = null;
let selectedTodayCategories = [];

document.querySelectorAll('.today-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const cat = btn.dataset.cat;
        if (selectedTodayCategories.includes(cat)) {
            selectedTodayCategories = selectedTodayCategories.filter(c => c !== cat);
            btn.style.background = '#007bff';
        } else {
            selectedTodayCategories.push(cat);
            btn.style.background = '#2ecc71';
        }
    });
});

function setStatus(msg, type='') {
    const s = document.getElementById('status');
    s.innerText = msg;
    s.style.color = type==='error' ? '#c0392b' : '#2ecc71';
}

async function fetchNews() {
    // ìš”ì²­ ì‹œì‘ ì‹œê°„ ê¸°ë¡
    const startTime = new Date();
    
    const cat = document.getElementById('category').value;
    let endpoint = '/api/news';
    if (cat) {
        endpoint = '/api/news/' + encodeURIComponent(cat);
        if (cat === 'ì˜¤ëŠ˜ì˜ì¶”ì²œ' && selectedTodayCategories.length) {
            endpoint += '?categories=' + encodeURIComponent(selectedTodayCategories.join(','));
        }
    }
    setStatus('ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
    try {
        const resp = await fetch(endpoint);
        const data = await resp.json();
        currentData = data;
        renderNews(data);

        // ìš”ì²­ ì™„ë£Œ ì‹œê°„ ê¸°ë¡ ë° ê²½ê³¼ ì‹œê°„ ê³„ì‚°
        const endTime = new Date();
        const elapsedTime = (endTime - startTime) / 1000; // ì´ˆ ë‹¨ìœ„
        const minutes = Math.floor(elapsedTime / 60);
        const seconds = Math.floor(elapsedTime % 60);
        const displayTime = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
        
        setStatus(`ë‰´ìŠ¤ ë¡œë“œ ì™„ë£Œ (${displayTime} ê±¸ë¦¼)`);
    } catch (e) {
        setStatus('ìš”ì²­ ì‹¤íŒ¨: ' + e.message, 'error');
    }
}

function renderNews(data) {
    const container = document.getElementById('newsContainer');
    container.innerHTML = '';
    if (!Array.isArray(data) || !data.length) {
        container.innerText = 'ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    const grid = document.createElement('div');
    grid.className = 'news-grid';
    data.forEach(n => {
        const card = document.createElement('div');
        card.className = 'news-card';
        const img = document.createElement('img');
        img.src = n.image_url || 'https://via.placeholder.com/400x200?text=No+Image';
        card.appendChild(img);
        const content = document.createElement('div');
        content.className = 'content';
        content.innerHTML = `
            <h3>${n.title}</h3>
            <p>${n.preview_summary}</p>
            <div class="meta">${n.pub_date || ''} | ${n.source} | views: ${n.view_count || 'None'}</div>
            <a href="${n.link}" target="_blank">ì›ë¬¸ ë³´ê¸°</a>
        `;
        card.appendChild(content);
        grid.appendChild(card);
    });
    container.appendChild(grid);
}

function showJson() {
    if(!currentData) return alert('ë¨¼ì € ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”');
    const w = window.open('', '_blank');
    w.document.write('<pre>' + JSON.stringify(currentData, null, 2) + '</pre>');
}
</script>
</body>
</html>
"""

@app.route('/test')
def test_page():
    return render_template_string(TEST_PAGE_HTML)

# -----------------------------
# ë‰´ìŠ¤ API (ì¹´í…Œê³ ë¦¬ë³„)
# -----------------------------
@app.route('/api/news', defaults={'category': None})
@app.route('/api/news/<category>')
def api_news(category):
    selected_cats = request.args.get('categories')
    selected_list = selected_cats.split(',') if selected_cats else []
    result = []
    categories_to_fetch = [category] if category and category != 'ì˜¤ëŠ˜ì˜ì¶”ì²œ' else (selected_list or list(CATEGORIES.keys()))
    
    # 5ê°œì˜ ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´, í•œ ë²ˆì— ìš”ì²­í•˜ëŠ” ê°œìˆ˜ë¥¼ ì¤„ì…ë‹ˆë‹¤.
    # ê° ì†ŒìŠ¤(ë„¤ì´ë²„, NewsAPI)ì—ì„œ 5ê°œë¥¼ ê°€ì ¸ì˜¤ë¯€ë¡œ, ì´ 10ê°œê¹Œì§€ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    for cat in categories_to_fetch:
        naver_items = news_service.get_naver_news(cat, count=5)
        newsapi_items = news_service.get_newsapi_news(cat, count=5)
        result.extend(normalize_and_enrich(naver_items, source='naver', category=cat))
        result.extend(normalize_and_enrich(newsapi_items, source='newsapi', category=cat))
    
    # ìµœì¢…ì ìœ¼ë¡œ 5ê°œë§Œ ë°˜í™˜í•˜ë„ë¡ ë¦¬ìŠ¤íŠ¸ë¥¼ ìë¦…ë‹ˆë‹¤.
    result = result[:5]

    result = sorted(result, key=lambda x: x.get('pub_date') or '', reverse=True)
    return jsonify(result)

@app.route('/api/categories')
def api_categories():
    return jsonify(list(CATEGORIES.keys()))

# -----------------------------
# ngrok ì‹œì‘
# -----------------------------
if NGROK_AUTHTOKEN:
    os.system(f"ngrok config add-authtoken {NGROK_AUTHTOKEN}")
    public_url = ngrok.connect(8000)
    print(f"ğŸ”— Public URL: {public_url}")

# -----------------------------
# ì„œë²„ ì‹¤í–‰
# -----------------------------
# -----------------------------
# ì„œë²„ ì‹¤í–‰ (ìˆ˜ì • ë²„ì „)
# -----------------------------
def start_server():
    # ngrok ì—°ê²°
    public_url = ngrok.connect(8000)
    print(f"ğŸŒ Ngrok URL: {public_url}")

    # Flask ì•± ì‹¤í–‰
    app.run(host='0.0.0.0', port=8000, debug=False, use_reloader=False)

# Colabì—ì„œ ì•ˆì „í•˜ê²Œ ìŠ¤ë ˆë“œë¡œ ì‹¤í–‰
threading.Thread(target=start_server, daemon=True).start()
print("âœ… ì„œë²„ ìŠ¤ë ˆë“œ ì‹¤í–‰ ì™„ë£Œ! /test ë˜ëŠ” /api/news/<category> í™•ì¸ ê°€ëŠ¥")
